<!DOCTYPE html> 
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timbro Ingressi/Uscite Murgo</title>
  <style>
    #log {
      white-space: pre-line;
      font-family: system-ui, sans-serif;
    }
  </style>
</head>
<body>
  <h2>ğŸ“ Invia La Tua Posizione</h2>

  <!-- Istruzioni compatte -->
  <div style="border: 1px solid #ccc; padding: 12px; margin-bottom: 20px; background-color: #f4f4f4; font-size: 0.95rem; line-height: 1.5;">
  <strong>ğŸ“² Primo utilizzo:</strong><br />
  - Apri le <strong>impostazioni di privacy</strong> del telefono e verifica che il browser (Safari, Chrome, Firefox, Edge) abbia il permesso di accedere alla posizione.<br />
  - Salva il link del modulo sulla schermata iniziale, creando una cartella chiamata <strong>â€œMurgo APPâ€</strong> per un accesso piÃ¹ rapido.

  <br /><br />
  <strong>ğŸ•˜ Utilizzo quotidiano:</strong><br />
  - Apri il link dalla cartella <strong>â€œMurgo APPâ€</strong><br />
  - Seleziona <em>Ingresso</em> o <em>Uscita</em><br />
  - Premi su <strong>â€œInvia Posizioneâ€</strong>

  <br /><br />
  <strong>ğŸ”’ Dati raccolti:</strong><br />
  ID risorsa, ID dispositivo, posizione (latitudine e longitudine) e precisione GPS.<br />
  <em>Questi dati sono usati esclusivamente per il calcolo delle ore lavorate e per scopi interni di controllo.</em>

  <br /><br />
  <strong>ğŸ†˜ Hai bisogno di supporto?</strong><br />
  Contatta Costantino via telefono o WhatsApp: <strong>+39 339 628 4734</strong>
  </div>

  <!-- ID dipendente -->
  <label for="name">ID Risorsa:</label><br />
  <input type="text" id="name" readonly /><br /><br />

  <!-- Tipo timbratura -->
  <label for="type">Tipo di timbratura:</label><br />
  <select id="type">
    <option value="Ingresso">ğŸŸ¢ Ingresso</option>
    <option value="Uscita">ğŸ”´ Uscita</option>
  </select><br /><br />

  <!-- Mostra device ID -->
  <label>ID dispositivo:</label><br />
  <code id="deviceDisplay"></code><br /><br />

  <!-- Bottone invio -->
  <button onclick="sendLocation()">ğŸ“¨ Invia Posizione</button>
  <pre id="log"></pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    const employeeId = params.get("id") || "Unknown";
    document.getElementById("name").value = employeeId;

    // Genera o recupera deviceId da localStorage
    let deviceId = localStorage.getItem("device_id");
    if (!deviceId) {
      deviceId = crypto.randomUUID();
      localStorage.setItem("device_id", deviceId);
    }
    document.getElementById("deviceDisplay").textContent = deviceId;

    function log(msg, reset = false) {
      const logEl = document.getElementById("log");
      logEl.textContent = reset ? msg + "\n" : logEl.textContent + msg + "\n";
    }

    async function sendLocation() {
      const type = document.getElementById("type").value;
      log("ğŸ“‹ Acquisizione posizione...", true);

      if (!navigator.geolocation) {
        log("âŒ Il browser non supporta la geolocalizzazione.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const accuracy = position.coords.accuracy;

          log("ğŸ“ Precisione stimata: " + accuracy.toFixed(0) + " metri");

          if (accuracy > 1000) {
            log("âš ï¸ Precisione troppo bassa. Usa Wi-Fi o un dispositivo con GPS.");
            return;
          }

          const payload = {
            name: employeeId,
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: accuracy,
            type: type,
            deviceId: deviceId
          };

          try {
            const res = await fetch("/.netlify/functions/sendLocation", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              log("âš ï¸ Risposta non valida.");
              return;
            }

            const result = await res.json();
            log(result.success ? "âœ… Posizione inviata con successo!" : "âŒ Errore: " + result.error);
          } catch (err) {
            log("âŒ Errore di rete: " + err.message);
          }
        },
        (error) => {
          log("âŒ Errore geolocalizzazione: " + error.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
  </script>
</body>
</html>

