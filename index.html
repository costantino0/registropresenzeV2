<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timbro Ingressi/Uscite Murgo</title>
</head>
<body>
  <h2>ğŸ“ Invia La Tua Posizione</h2>

  <!-- ID dipendente -->
  <label for="name">ID Risorsa:</label><br />
  <input type="text" id="name" readonly /><br /><br />

  <!-- Tipo timbratura -->
  <label for="type">Tipo di timbratura:</label><br />
  <select id="type">
    <option value="Ingresso">ğŸŸ¢ Ingresso</option>
    <option value="Uscita">ğŸ”´ Uscita</option>
  </select><br /><br />

  <!-- Mostra device ID -->
  <label>ID dispositivo:</label><br />
  <code id="deviceDisplay"></code><br /><br />

  <!-- Bottone invio -->
  <button onclick="sendLocation()">ğŸ“¨ Invia Posizione</button>
  <pre id="log"></pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    const employeeId = params.get("id") || "Unknown";
    document.getElementById("name").value = employeeId;

    // Genera o recupera deviceId da localStorage
    let deviceId = localStorage.getItem("device_id");
    if (!deviceId) {
      deviceId = crypto.randomUUID();
      localStorage.setItem("device_id", deviceId);
    }
    document.getElementById("deviceDisplay").textContent = deviceId;

    function log(msg) {
      document.getElementById("log").textContent += msg + "\n";
    }

    async function sendLocation() {
      const type = document.getElementById("type").value;
      log("ğŸ“‹ Acquisizione posizione...");

      if (!navigator.geolocation) {
        log("âŒ Il browser non supporta la geolocalizzazione.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const accuracy = position.coords.accuracy;

          log("ğŸ“ Precisione stimata: " + accuracy.toFixed(0) + " metri");

          if (accuracy > 1000) {
            log("âš ï¸ La precisione Ã¨ molto bassa. Ti consigliamo di usare uno smartphone o attivare il Wi-Fi.");
            return;
          }

          const payload = {
            name: employeeId,
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: accuracy,
            type: type,
            deviceId: deviceId
          };

          log("ğŸ“¤ Dati da inviare:\n" + JSON.stringify(payload, null, 2));

          try {
            const res = await fetch("/.netlify/functions/sendLocation", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            log("ğŸ“¥ Risposta:\n" + text);

            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              log("âš ï¸ Risposta non in formato JSON.");
              return;
            }

            const result = JSON.parse(text);
            log(result.success ? "âœ… Posizione inviata con successo!" : "âŒ Errore: " + result.error);
          } catch (err) {
            log("âŒ Errore di rete: " + err.message);
          }
        },
        (error) => {
          log("âŒ Errore geolocalizzazione: " + error.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
  </script>
</body>
</html>
