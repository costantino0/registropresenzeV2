<!DOCTYPE html> 
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timbro Ingressi/Uscite Murgo</title>
  <style>
    #log {
      white-space: pre-line;
      font-family: system-ui, sans-serif;
    }
  </style>
</head>
<body>
  <h2>üìç Invia La Tua Posizione</h2>

  <!-- Istruzioni compatte -->
  <div style="border: 1px solid #ccc; padding: 12px; margin-bottom: 20px; background-color: #f4f4f4;">
    <strong>‚Ñπ Istruzioni:</strong> Apri il link ricevuto, abilita la geolocalizzazione sul browser, seleziona se si tratta di <em>Ingresso</em> o <em>Uscita</em>, quindi premi <strong>Invia Posizione</strong>.<br />
    I dati raccolti (ID risorsa, ID dispositivo, posizione e precisione) saranno usati solo per il calcolo delle ore lavorate.
  </div>

  <!-- ID dipendente -->
  <label for="name">ID Risorsa:</label><br />
  <input type="text" id="name" readonly /><br /><br />

  <!-- Tipo timbratura -->
  <label for="type">Tipo di timbratura:</label><br />
  <select id="type">
    <option value="Ingresso">üü¢ Ingresso</option>
    <option value="Uscita">üî¥ Uscita</option>
  </select><br /><br />

  <!-- Mostra device ID -->
  <label>ID dispositivo:</label><br />
  <code id="deviceDisplay"></code><br /><br />

  <!-- Bottone invio -->
  <button onclick="sendLocation()">üì® Invia Posizione</button>
  <pre id="log"></pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    const employeeId = params.get("id") || "Unknown";
    document.getElementById("name").value = employeeId;

    // Genera o recupera deviceId da localStorage
    let deviceId = localStorage.getItem("device_id");
    if (!deviceId) {
      deviceId = crypto.randomUUID();
      localStorage.setItem("device_id", deviceId);
    }
    document.getElementById("deviceDisplay").textContent = deviceId;

    function log(msg, reset = false) {
      const logEl = document.getElementById("log");
      logEl.textContent = reset ? msg + "\n" : logEl.textContent + msg + "\n";
    }

    async function sendLocation() {
      const type = document.getElementById("type").value;
      log("üìã Acquisizione posizione...", true);

      if (!navigator.geolocation) {
        log("‚ùå Il browser non supporta la geolocalizzazione.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const accuracy = position.coords.accuracy;

          log("üìè Precisione stimata: " + accuracy.toFixed(0) + " metri");

          if (accuracy > 1000) {
            log("‚ö†Ô∏è Precisione troppo bassa. Usa Wi-Fi o un dispositivo con GPS.");
            return;
          }

          const payload = {
            name: employeeId,
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: accuracy,
            type: type,
            deviceId: deviceId
          };

          try {
            const res = await fetch("/.netlify/functions/sendLocation", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              log("‚ö†Ô∏è Risposta non valida.");
              return;
            }

            const result = await res.json();
            log(result.success ? "‚úÖ Posizione inviata con successo!" : "‚ùå Errore: " + result.error);
          } catch (err) {
            log("‚ùå Errore di rete: " + err.message);
          }
        },
        (error) => {
          log("‚ùå Errore geolocalizzazione: " + error.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
  </script>
</body>
</html>

